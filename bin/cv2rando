#!/usr/bin/env node --no-warnings

const { cyan, gray, green, red, yellow } = require('chalk');
const { exec } = require('child_process');
const camelcase = require('camelcase');
const cv2rando = require('../lib/cv2rando');
const fs = require('fs').promises;
const os = require('os');
const path = require('path');
const program = require('commander');
const { isAllFlag, pad } = require('../lib/utils');
const { difficulty } = require('../cv2rando.manifest.js');

const difficulties = Object.keys(difficulty);

program
	.version(require('../package.json').version)
	.description('Castlevania II: Simon\'s Quest Randomizer by BloodSweatAndCode')
	.usage('[options] [vanilla_rom_file]')
	.option('-d, --difficulty <difficulty>', `Difficulty setting: [ ${difficulties} ]`, 'standard')
	.option('-o, --output <output>', 'filepath for randomized rom output')
	//.option('-p, --prices', '[ITEMIZER] randomize merchant prices')
	.option('-r, --run', 'immediately run with emulator after randomizing (fceux or OpenEmu must be in PATH)')
	.option('-s, --seed <seed>', 'seed to use for randomization')
	.option('-z, --debug', 'enable debug output');

program.outputHelp = function(cb) {
	// make sure we don't have conflicting flags
	const found = {};
	this.options.forEach(o => {
		if (!found[o.short]) { 
			found[o.short] = o; 
		} else {
			throw new Error(`short flag "${o.short}" already used with option "${found[o.short].flags}"`);
		}
		if (!found[o.long]) { 
			found[o.long] = o; 
		} else {
			throw new Error(`long flag "${o.long}" already used with option "${found[o.long].flags}"`);
		}
	});

	// find the longest flags string in our options
	const longest = Math.max(...(this.options.map(o => o.flags.length)));
	const p = str => pad(str, longest);

	// print help
	console.log(red(this.description()));
	console.log('');
	console.log(cyan('Usage'));
	console.log(`  cv2rando ${this.usage()}`);
	console.log('');
	console.log(cyan('Examples'));
	console.log(gray('  # Show this help (Windows)'));
	console.log('  node .\\bin\\cv2rando --help');
	console.log('');
	console.log(gray('  # Show this help (Mac/Linux)'));
	console.log('  ./bin/cv2rando --help');
	console.log('');
	console.log(gray('  # Generate a rom with the seed "BSAC" at standard difficulty (Windows)'));
	console.log('  node .\\bin\\cv2rando --seed BSAC cv2.nes');
	console.log('');
	console.log(gray('  # Generate a rom with the seed "BurbAndSath" at hard difficulty (Mac/Linux)'));
	console.log('  ./bin/cv2rando --seed BurbAndSath --difficulty hard cv2.nes');
	console.log('');
	console.log(cyan('Options'));
	this.options.forEach(o => console.log(`  ${p(o.flags)}  ${p(o.description)}`));
	console.log('');
}

async function main() {
	try {
		// process command line arguments
		program.parse(process.argv);
		if (program.debug) {
			global.debug = true;
		}
		if (!difficulties.includes(program.difficulty)) {
			throw new Error(`invalid difficulty, must be [ ${difficulties.join(', ')} ]`);
		}
		program.rom = program.args[0];

		// create the rando based on command line options and config.json
		const output = await cv2rando(program);
		console.log(`CV2 Randomizer ${green('successful!')}`);
		console.log(`* rom:     ${cyan(output.rom)}`);
		console.log(`* patch:   ${cyan(output.patch)}`);
		console.log(`* spoiler: ${cyan(output.spoiler)}`);

		// run the rom, if necessary
		if (program.run) {
			const cmd = os.platform() === 'darwin' ? 
				`open -a OpenEmu ${output.rom}` : 
				`fceux ${output.rom}`;
			console.log('');
			console.log(`Launching randomized rom with ${cyan(cmd)}`);
			exec(cmd);
		}
	} catch (err) {
		console.error(red('### CV2 Randomizer creation failed ###'));
		console.log(red(err.stack));
		process.exit(1);
	}
}

main();